
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Containers &#8212; HPC2: Installing and Managing Applications on the HPC</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://arctraining.github.io/hpc2-software/course/containers.html" />
    <link rel="shortcut icon" href="../_static/favicon-32x32.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Spack" href="spack.html" />
    <link rel="prev" title="Autotools" href="autotools.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">HPC2: Installing and Managing Applications on the HPC</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../welcome.html">
                    HPC2: Installing and Managing Applications on the HPC
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="start.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="example.html">
   Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="autotools.html">
   Autotools
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Containers
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="spack.html">
   Spack
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="spack/installing.html">
     Installing Spack
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="spack/testinstall.html">
     Building a test piece of software
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="spack/modules.html">
     Adjusting how we name modules
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="spack/existing.html">
     Using existing software
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="spack/advanced.html">
     Advanced software install
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="spack/containers.html">
     Containers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="spack/environments.html">
     Environments
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="spack/recipes.html">
     Recipes
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="conda.html">
   Conda package manager
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cmake.html">
   CMake
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Visit the <a href="https://arcleeds.github.io/">Research Computing Home Site</a> <div> This book is powered by <a href="https://jupyterbook.org">Jupyter Book</a> </div>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ARCTraining/hpc2-software"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ARCTraining/hpc2-software/issues/new?title=Issue%20on%20page%20%2Fcourse/containers.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ARCTraining/hpc2-software/edit/gh-pages/book/course/containers.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/course/containers.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-are-containers">
   What are containers?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#why-do-i-want-a-container">
   Why do I want a container?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#can-i-use-docker-on-hpc">
   Can I use Docker on HPC?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#singularity-vs-apptainer">
   Singularity vs Apptainer
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-of-running-a-container">
   Example of running a container
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-do-those-steps-mean">
     What do those steps mean?
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#pulling-a-container-image-down-from-docker-hub">
       Pulling a container image down from Docker Hub
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#converting-it-into-a-sif-image">
       Converting it into a SIF image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#running-software-within-a-container">
       Running software within a container
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-else-can-i-do-with-containers">
   What else can I do with containers?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#access-host-storage-within-a-container">
     Access host storage within a container
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-an-alternative-command-within-a-container">
     Run an alternative command within a container
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#have-an-interactive-shell-inside-the-container">
     Have an interactive shell inside the container
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#use-gpus-within-a-container">
     Use GPUs within a container
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#building-a-container">
   Building a container
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-a-recipe">
     Creating a recipe
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#converting-a-dockerfile-to-a-singularity-recipe">
     Converting a Dockerfile to a Singularity recipe
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generate-a-sif-image-from-a-recipe">
     Generate a SIF image from a recipe
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-the-image-we-ve-created">
     Test the image we’ve created
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#submitting-jobs-with-containers">
   Submitting jobs with containers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bonus-section">
   Bonus section
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Containers</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-are-containers">
   What are containers?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#why-do-i-want-a-container">
   Why do I want a container?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#can-i-use-docker-on-hpc">
   Can I use Docker on HPC?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#singularity-vs-apptainer">
   Singularity vs Apptainer
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-of-running-a-container">
   Example of running a container
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-do-those-steps-mean">
     What do those steps mean?
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#pulling-a-container-image-down-from-docker-hub">
       Pulling a container image down from Docker Hub
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#converting-it-into-a-sif-image">
       Converting it into a SIF image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#running-software-within-a-container">
       Running software within a container
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-else-can-i-do-with-containers">
   What else can I do with containers?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#access-host-storage-within-a-container">
     Access host storage within a container
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-an-alternative-command-within-a-container">
     Run an alternative command within a container
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#have-an-interactive-shell-inside-the-container">
     Have an interactive shell inside the container
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#use-gpus-within-a-container">
     Use GPUs within a container
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#building-a-container">
   Building a container
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-a-recipe">
     Creating a recipe
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#converting-a-dockerfile-to-a-singularity-recipe">
     Converting a Dockerfile to a Singularity recipe
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generate-a-sif-image-from-a-recipe">
     Generate a SIF image from a recipe
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-the-image-we-ve-created">
     Test the image we’ve created
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#submitting-jobs-with-containers">
   Submitting jobs with containers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bonus-section">
   Bonus section
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="containers">
<h1>Containers<a class="headerlink" href="#containers" title="Permalink to this headline">#</a></h1>
<section id="what-are-containers">
<h2>What are containers?<a class="headerlink" href="#what-are-containers" title="Permalink to this headline">#</a></h2>
<p>Containers are a bit like VMs, but less contained than that.  It probably helps
to look at a diagram to help understand the limits of containers, compared to
virtual machines:</p>
<a class="reference internal image-reference" href="../_images/Docker-containerized-and-vm-transparent-bg.png"><img alt="What is a container, docker.com, CC BY-SA 4.0 &lt;https://creativecommons.org/licenses/by-sa/4.0&gt;, via Wikimedia Commons" class="align-center" src="../_images/Docker-containerized-and-vm-transparent-bg.png" style="width: 600px;" /></a>
<p><em><a class="reference external" href="http://docker.com">docker.com</a>, CC BY-SA 4.0 <a class="reference external" href="https://creativecommons.org/licenses/by-sa/4.0">https://creativecommons.org/licenses/by-sa/4.0</a>, via Wikimedia Commons</em></p>
<p>The important bit to understand here, is what a container doesn’t contain.
Fundamentally, a container doesn’t include the base of the operating system,
the kernel.  So if you use a container technology on Linux, and your host
operating system runs Linux with a 4.18 kernel, then that’s what everything
inside your container sees as well.  This is quite different to running an
actual virtual machine, where what’s seen by running code can be entirely
different to the hypervisor’s operating system.  Additionally, with a virtual
machine, you have to choose how much RAM you allocate when you start it up,
unlike a container which can use all of the host system’s memory, in the same
way a normal process can.  This lack of total containment also means you get
full access to the network and GPUs of the host.</p>
</section>
<section id="why-do-i-want-a-container">
<h2>Why do I want a container?<a class="headerlink" href="#why-do-i-want-a-container" title="Permalink to this headline">#</a></h2>
<p>One of the problems with running software on different systems is that it can
be hard work recreating the software environment across systems, where you may
be running a different operating system distribution.  By using a container, you can spend the
effort once to create the software environment, and share that image and
use it on quite different systems.  By also publishing the recipe, you make it
very clear how you created this software environment, making it much easier to
update this in future.</p>
</section>
<section id="can-i-use-docker-on-hpc">
<h2>Can I use Docker on HPC?<a class="headerlink" href="#can-i-use-docker-on-hpc" title="Permalink to this headline">#</a></h2>
<p><strong>No.</strong></p>
<p>That’s the short answer.  The longer answer is, you generally shouldn’t want
to.  Docker is excellent for running web services in containerised
environments, but doesn’t really have a security model that suits HPC, due to
the way it works.  Singularity/Apptainer solve this by allowing you to use
Docker containers, but via a tool that uses an alternative security model,
where containers run with the permissions of the user who is running them.
That makes them perfect for HPC, where we want all your work to run as your
user.</p>
</section>
<section id="singularity-vs-apptainer">
<h2>Singularity vs Apptainer<a class="headerlink" href="#singularity-vs-apptainer" title="Permalink to this headline">#</a></h2>
<p>First there was Singularity, then there was commercialisation that kept an open
source version, then a while after a fork after a slight disagreement, and
Apptainer was born.  Apptainer has been developed from Singularity, and we’ll
only be looking at Apptainer in this course, but much of what’s listed will
equally apply to Singularity.  Whilst there remains a community edition of
Singularity, we’ll only be looking at Apptainer, but have tended to use the
<code class="docutils literal notranslate"><span class="pre">singularity</span></code> command line, which is still provided for backwards
compatibility.  Anywhere we use the <code class="docutils literal notranslate"><span class="pre">singularity</span></code> command, you could instead
use <code class="docutils literal notranslate"><span class="pre">apptainer</span></code>.</p>
</section>
<section id="example-of-running-a-container">
<h2>Example of running a container<a class="headerlink" href="#example-of-running-a-container" title="Permalink to this headline">#</a></h2>
<p>It’s always good to do something simple to start with, to prove to yourself
things are working:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the legacy singularity module</span>
$ module add singularity

<span class="c1"># Download a simple container</span>
$ singularity pull docker://godlovedc/lolcow

<span class="c1"># Run it</span>
$ singularity run lolcow_latest.sif
INFO:    Using cached SIF image
 _________________________________________
/ This night methinks is but the daylight <span class="se">\</span>
<span class="p">|</span> sick.                                   <span class="p">|</span>
<span class="p">|</span>                                         <span class="p">|</span>
<span class="p">|</span> -- William Shakespeare, <span class="s2">&quot;The Merchant   |</span>
<span class="s2">\ of Venice&quot;</span>                              /
 -----------------------------------------
        <span class="se">\ </span>  ^__^
         <span class="se">\ </span> <span class="o">(</span>oo<span class="o">)</span><span class="se">\_</span>______
            <span class="o">(</span>__<span class="o">)</span><span class="se">\ </span>      <span class="o">)</span><span class="se">\/\</span>
                <span class="o">||</span>----w <span class="p">|</span>
                <span class="o">||</span>     <span class="o">||</span>
</pre></div>
</div>
<p>It might not look on the face of it that this is very impressive, but we’ve just:</p>
<ul class="simple">
<li><p>pulled down a container from docker hub</p></li>
<li><p>converted it into a SIF image</p></li>
<li><p>run a piece of software, within an Ubuntu container on a CentOS host</p></li>
</ul>
<section id="what-do-those-steps-mean">
<h3>What do those steps mean?<a class="headerlink" href="#what-do-those-steps-mean" title="Permalink to this headline">#</a></h3>
<section id="pulling-a-container-image-down-from-docker-hub">
<h4>Pulling a container image down from Docker Hub<a class="headerlink" href="#pulling-a-container-image-down-from-docker-hub" title="Permalink to this headline">#</a></h4>
<p>Docker Hub is a repository of containers, also known as a container registry.  Pulling down a container involves
pulling down the pieces of this container image over to your machine.</p>
</section>
<section id="converting-it-into-a-sif-image">
<h4>Converting it into a SIF image<a class="headerlink" href="#converting-it-into-a-sif-image" title="Permalink to this headline">#</a></h4>
<p>Docker uses a container format that involves a number of layers, that add up
together to form your final container image.  Singularity uses a different
format SIF, which is a single file that contains everything you need to run
your container.</p>
</section>
<section id="running-software-within-a-container">
<h4>Running software within a container<a class="headerlink" href="#running-software-within-a-container" title="Permalink to this headline">#</a></h4>
<p>When you come to use a container, you can run software inside the container,
but also see file shares outside the container, and access resources like
network and GPU of the host machine.  This allows us to use all the power of an
HPC, but with a software environment we’ve brought with us from elsewhere.  In
the example we used <code class="docutils literal notranslate"><span class="pre">run</span></code> which executes a predefined piece of software
within the container, but you are not limited to only running the command set
when the container was created.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You normally have read only access to the container, and only have write access
to directories of the host mapped into the container.</p>
</div>
</section>
</section>
</section>
<section id="what-else-can-i-do-with-containers">
<h2>What else can I do with containers?<a class="headerlink" href="#what-else-can-i-do-with-containers" title="Permalink to this headline">#</a></h2>
<section id="access-host-storage-within-a-container">
<h3>Access host storage within a container<a class="headerlink" href="#access-host-storage-within-a-container" title="Permalink to this headline">#</a></h3>
<p>By default with Apptainer, your home directory and <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> are mapped into the
container.  On ARC4 we also default to mapping <code class="docutils literal notranslate"><span class="pre">/nobackup</span></code> and <code class="docutils literal notranslate"><span class="pre">/local</span></code> inside the
container.  If you want other directories to be mapped, you have to ask for
them.  If you wanted <code class="docutils literal notranslate"><span class="pre">/data</span></code> to be visible inside the container, you can just do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ singularity run -B /data example.sif
</pre></div>
</div>
<p>Or if you wanted to make something visible somewhere else (so <code class="docutils literal notranslate"><span class="pre">/data</span></code> outside
is presented within the container as <code class="docutils literal notranslate"><span class="pre">/scratch</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ singularity run -B /data:/scratch example.sif
</pre></div>
</div>
</section>
<section id="run-an-alternative-command-within-a-container">
<h3>Run an alternative command within a container<a class="headerlink" href="#run-an-alternative-command-within-a-container" title="Permalink to this headline">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ singularity <span class="nb">exec</span> example.sif cat /etc/issue
Ubuntu <span class="m">16</span>.04.3 LTS <span class="se">\n</span> <span class="se">\l</span>
</pre></div>
</div>
</section>
<section id="have-an-interactive-shell-inside-the-container">
<h3>Have an interactive shell inside the container<a class="headerlink" href="#have-an-interactive-shell-inside-the-container" title="Permalink to this headline">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ singularity shell example.sif
</pre></div>
</div>
</section>
<section id="use-gpus-within-a-container">
<h3>Use GPUs within a container<a class="headerlink" href="#use-gpus-within-a-container" title="Permalink to this headline">#</a></h3>
<p>Singularity has a lovely way of pulling drivers and libraries for the GPU from
the host system into the container.  In this way we can have a container that
supports GPUs without the pain of having to have all the right drivers included
within it.  At runtime you just do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ singularity run --nv example.sif
</pre></div>
</div>
<p>All available Nvidia GPUs are then visible to the container, along with the
necessary drivers to use them.  If you need a CUDA SDK or similar, that would
need to be included within the container.</p>
</section>
</section>
<section id="building-a-container">
<h2>Building a container<a class="headerlink" href="#building-a-container" title="Permalink to this headline">#</a></h2>
<p>Now, what if an existing Docker container doesn’t exist, and I want to build
myself a container?</p>
<p>With Singularity, you needed root access, or a special tweak made to allow you
to build containers.  Neither of those were an option on the HPC, but are if
you have access to either a Linux desktop, or a virtual machine.</p>
<p>Apptainer makes things more interesting, as it supports a mode of operation
that removes the need for additional rights, and so we’re looking to roll this
out universally in the near future.  If you have access to a university RHEL 8
system, we should be able to enable Apptainer on your machine now, if it’s not
already available.</p>
<p>This is also now available on ARC4.</p>
<section id="creating-a-recipe">
<h3>Creating a recipe<a class="headerlink" href="#creating-a-recipe" title="Permalink to this headline">#</a></h3>
<p>A recipe lists all the steps needed to make a container, and also what happens
when we run a container.  I’m starting with a fairly silly little example.
Let’s create a file called lolcow.def:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>BootStrap: docker
From: ubuntu:16.04

%post
  apt-get -y update
  apt-get -y install fortune cowsay lolcat

%environment
  export LC_ALL=C
  export PATH=/usr/games:$PATH

%runscript
  fortune | cowsay | lolcat
</pre></div>
</div>
<p>This container starts with a Docker container (Ubuntu 16.04), and installs a few necessary packages.  Then it defines what happens when we run it: <code class="docutils literal notranslate"><span class="pre">fortune</span> <span class="pre">|</span> <span class="pre">cowsay</span> <span class="pre">|</span> <span class="pre">lolcat</span></code>.</p>
</section>
<section id="converting-a-dockerfile-to-a-singularity-recipe">
<h3>Converting a Dockerfile to a Singularity recipe<a class="headerlink" href="#converting-a-dockerfile-to-a-singularity-recipe" title="Permalink to this headline">#</a></h3>
<p>There’s a tool written in Python that allows you to convert from a Dockerfile into a Singularity format file.  Whilst not perfect, this often allows for simple creations of images, where no prebuilt Docker image exists:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load anaconda</span>
$ module add anaconda

<span class="c1"># Install spython (only need to do this once)</span>
$ pip install spython --user

<span class="c1"># Download an example Dockerfile</span>
$ wget https://raw.githubusercontent.com/GodloveD/lolcow/master/Dockerfile

<span class="c1"># Convert it into Singularity format</span>
$ spython recipe Dockerfile lolcow.def
</pre></div>
</div>
<p>Then you could proceed to build it into a SIF file as show below.</p>
</section>
<section id="generate-a-sif-image-from-a-recipe">
<h3>Generate a SIF image from a recipe<a class="headerlink" href="#generate-a-sif-image-from-a-recipe" title="Permalink to this headline">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ singularity build lolcow.sif lolcow.def
</pre></div>
</div>
</section>
<section id="test-the-image-we-ve-created">
<h3>Test the image we’ve created<a class="headerlink" href="#test-the-image-we-ve-created" title="Permalink to this headline">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ singularity run lolcow.sif
/ Q: How did you get into artificial   \
| intelligence? A: Seemed logical -- I |
\ didn&#39;t have any real intelligence.   /
 --------------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</pre></div>
</div>
</section>
</section>
<section id="submitting-jobs-with-containers">
<h2>Submitting jobs with containers<a class="headerlink" href="#submitting-jobs-with-containers" title="Permalink to this headline">#</a></h2>
<p>There’s no great difference with submitting jobs to use containers than there
is using them interactively.  Here’s an example job submission:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run with the current working directory</span>
<span class="c1">#$ -cwd</span>
<span class="c1"># Run for up to ten minutes</span>
<span class="c1">#$ -l h_rt=0:10:0</span>
<span class="c1"># Request 8 cores</span>
<span class="c1">#$ -pe smp 8</span>

<span class="c1"># Load the necessary module</span>
<span class="n">module</span> <span class="n">add</span> <span class="n">apptainer</span>

<span class="c1"># Run the default command in the container</span>
<span class="n">singularity</span> <span class="n">run</span> <span class="n">lolcow_latest</span><span class="o">.</span><span class="n">sif</span>

<span class="c1"># Run a custom command inside the container</span>
<span class="n">singularity</span> <span class="n">exec</span> <span class="n">lolcow_latest</span><span class="o">.</span><span class="n">sif</span> <span class="n">fortune</span>
</pre></div>
</div>
</section>
<section id="bonus-section">
<h2>Bonus section<a class="headerlink" href="#bonus-section" title="Permalink to this headline">#</a></h2>
<p>There’s more content we’d like to include than we’ve really got time for, but
some bonus content is available here.</p>
<div class="dropdown admonition">
<p class="admonition-title">Sandboxes</p>
<p>When writing a recipe you may find it hard to come up with a working recipe first time.  This is where sandboxes can come in handy.  If you create a sandbox, rather than creating an image file, it writes out the files into a directory, and you can then have a container run in this directory, but with write access, which you do not normally have.  So you write your basic recipe, and build the container like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ singularity build --sandbox lolcow lolcow.def
</pre></div>
</div>
<p>Now we can have a session within it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ singularity shell --fakeroot --writable lolcow
</pre></div>
</div>
<p>You can now experiment inside this sandbox to work out what you need for your recipe.</p>
</div>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">#</a></h2>
<p><a class="reference external" href="https://apptainer.org/docs/user/main/">Apptainer Documentation</a></p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">#</a></h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<ul class="simple">
<li><p><a class="reference external" href="#what-are-containers">What are containers</a>?</p></li>
<li><p><a class="reference external" href="#why-do-i-want-a-container">Why do I want a container</a>?</p></li>
<li><p><a class="reference external" href="#can-i-use-docker-on-hpc">Can I use Docker on HPC</a>?</p></li>
<li><p><a class="reference external" href="#singularity-vs-apptainer">Singularity vs Apptainer</a></p></li>
<li><p><a class="reference external" href="#example-of-running-a-container">Example of running a container</a> and a look into the steps involved:</p>
<ul>
<li><p><a class="reference external" href="#pulling-a-container-down-from-docker-hub">Pulling a container image down from Docker Hub</a></p></li>
<li><p><a class="reference external" href="#converting-it-into-a-sif-image">Converting it into a SIF image</a></p></li>
<li><p><a class="reference external" href="#running-software-within-a-container">Running software within a container</a></p></li>
</ul>
</li>
<li><p>What else can I do with containers?</p>
<ul>
<li><p><a class="reference external" href="#access-host-storage-within-a-container">Access host storage within a container</a></p></li>
<li><p><a class="reference external" href="#run-an-alternative-command-within-a-container">Run an alternative command within a container</a></p></li>
<li><p><a class="reference external" href="#have-an-interactive-shell-inside-the-container">Have an interactive shell inside the container</a></p></li>
<li><p><a class="reference external" href="#use-gpus-within-a-container">Use GPUs within a container</a></p></li>
</ul>
</li>
<li><p>Building a container</p>
<ul>
<li><p><a class="reference external" href="#creating-a-recipe">Creating a recipe</a></p></li>
<li><p><a class="reference external" href="#converting-a-dockerfile-to-a-singularity-recipe">Converting a Dockerfile to a Singularity recipe</a></p></li>
<li><p><a class="reference external" href="#generate-a-sif-image-from-a-recipe">Generate a SIF image from a recipe</a></p></li>
<li><p><a class="reference external" href="#test-the-image-we-ve-created">Test the image we’ve created</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#submitting-jobs-with-containers">Submitting jobs with containers</a></p></li>
<li><p>Bonus section</p>
<ul>
<li><p><a class="reference external" href="#sandboxes">Sandboxes</a></p></li>
</ul>
</li>
</ul>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./course"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="autotools.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Autotools</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="spack.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Spack</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By University of Leeds Research Computing Team<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>